<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kallos</title>

<link rel="stylesheet" href="style.css">

<script>
  // Sprawdź logowanie
  // Note: when opening files locally (file://) some browsers treat each file
  // as a separate "origin" and localStorage is not shared between them.
  // To avoid a login loop in local preview, we only enforce the redirect
  // when the app is running over HTTP/HTTPS.
  const isHttpContext = window.location.protocol === 'http:' || window.location.protocol === 'https:';
  if (isHttpContext && !localStorage.getItem('kallos_user')) {
    window.location.href = 'kallos-login.html';
  }

  // WCZYTAJ ZAPISANY MOTYW
  const savedTheme = localStorage.getItem('kallos_theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
</script>

</head>
<body data-theme="light">

<div class="app" role="application" aria-labelledby="appTitle">
  <header class="app-header" role="banner">
    <div class="brand">
      <img src="Resources/kallos-logo.jpg" alt="Logo Kallos" class="logo">
      <div>
        <h1 id="appTitle" style="margin:0">Kallos</h1>
        <div class="muted small">Pay analytics application</div>
      </div>
    </div>

    <div class="controls">
      <label for="theme-select" class="visually-hidden">Interface theme</label>
      <select id="theme-select" aria-label="Choose interface theme" style="width:auto">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
        <option value="high-contrast">High contrast</option>
      </select>
      
      <div class="user-badge" id="userInfo">
        <span class="muted small">Signed in as</span>
        <strong id="displayUsername">...</strong>
      </div>
      
      <button id="logoutBtn" class="btn btn-outline">Log out</button>
    </div>
  </header>

  <nav class="sidebar" role="navigation" aria-label="Main menu">
    <ul class="nav-list" role="list">
      <li><button data-view="dashboard" aria-current="true">Dashboard</button></li>
      <li><button data-view="import">Import data</button></li>
      <li><button data-view="data">Data</button></li>
      <li><button data-view="visual">Visualisations</button></li>
      <li><button data-view="analysis">Analysis</button></li>
      <li><button data-view="reports">Generate report</button></li>
      <li><button data-view="admin">Admin</button></li>
      <li><button data-view="help">Help</button></li>
    </ul>
  </nav>

<main id="main-content" class="content" role="main">
    <div id="status" role="status" aria-live="polite" class="visually-hidden"></div>

    <section id="view-dashboard" class="view" aria-hidden="false">
      <div class="toolbar">
        <div class="kpi card">
          <div>
            <div class="muted">Records</div>
            <div class="num" id="kpi-records">0</div>
          </div>
        </div>
        <div class="kpi card">
          <div>
            <div class="muted">Last import</div>
            <div class="num" id="kpi-last">—</div>
          </div>
        </div>
        <div class="kpi card">
          <div>
            <div class="muted">Average pay</div>
            <div class="num" id="kpi-avg">—</div>
          </div>
        </div>
        <div style="margin-left:auto">
          <button id="quick-import" class="btn">Import file</button>
        </div>
      </div>

      <div class="grid two-col">
        <div class="card">
          <h2>Overview</h2>
          <p class="muted">Quick actions and a summary of key metrics.</p>

          <div id="small-charts" class="grid full" style="margin-top:12px; gap:8px">
            <div class="card" id="chart-sample" style="min-height:160px">
              <strong>Pay distribution – sample chart</strong>
              <div id="mini-chart" class="chart-area" aria-hidden="true"></div>
            </div>
            <div class="card">
              <strong>Recent activity</strong>
              <ul id="log-list" class="muted small" style="margin:8px 0 0 16px; padding:0"></ul>
            </div>
          </div>
        </div>

        <aside class="card" aria-labelledby="asideTitle">
          <h3 id="asideTitle">Global filters</h3>
          <div class="form-row">
            <label for="filter-agency">Agency</label>
            <select id="filter-agency"><option value="">All</option></select>
          </div>
          <div class="form-row">
            <label for="filter-year">Year</label>
            <select id="filter-year"><option value="">All</option></select>
          </div>
          <div>
            <button id="apply-filters" class="btn">Apply</button>
          </div>
        </aside>
      </div>
    </section>

    <section id="view-import" class="view" style="display:none" aria-hidden="true">
      <h2>Import pay data</h2>
      <p class="muted">Supported formats: CSV / TXT. Required columns: <code>name,agency,grade,salary,start_date</code></p>
      <div class="card">
        <form id="import-form" aria-describedby="import-desc">
          <div id="import-desc" class="muted">Drag &amp; drop a file or pick it from disk. You can preview rows and map columns.</div>
          <div style="margin-top:12px;">
            <input id="file-input" type="file" accept=".csv,.txt" aria-label="Choose CSV file" />
          </div>
          <div id="map-area" style="margin-top:12px; display:none">
            <strong>Column mapping</strong>
            <div id="map-rows" style="margin-top:8px"></div>
            <div style="margin-top:10px">
              <button type="button" id="start-import" class="btn">Import</button>
              <button type="button" id="cancel-import" style="margin-left:8px">Cancel</button>
            </div>
          </div>
          <div id="preview-area" style="margin-top:12px; display:none">
            <strong>File preview (first rows)</strong>
            <div class="table-wrap card" id="preview-table-wrap" style="margin-top:8px"></div>
          </div>
        </form>
      </div>
    </section>

    <section id="view-data" class="view" style="display:none" aria-hidden="true">
      <h2>Data</h2>
      <p class="muted">Browse raw data. You can filter, sort and export selected records.</p>
      <div class="card">
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
          <input id="search-input" type="text" placeholder="Search (name, agency...)" aria-label="Search in data" />
          <button id="export-csv" class="btn">Export CSV</button>
          <div style="margin-left:auto" class="muted small">Selected: <span id="selected-count">0</span></div>
        </div>
        <div class="table-wrap">
          <table id="data-table" aria-describedby="table-desc">
            <caption id="table-desc" class="visually-hidden">Table of pay records</caption>
            <thead>
              <tr><th><input id="select-all" type="checkbox" aria-label="Select all rows"></th><th>Name</th><th>Agency</th><th>Grade</th><th>Salary</th><th>Hire date</th></tr>
            </thead>
            <tbody id="table-body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="view-visual" class="view" style="display:none" aria-hidden="true">
      <h2>Visualisations</h2>
      <p class="muted">Choose variables and generate a chart. Example: average pay per grade.</p>
      <div class="grid full">
        <div class="card">
          <div class="form-row">
            <label for="vis-type">Chart type</label>
            <select id="vis-type"><option value="bar">Bar</option><option value="line">Line (demo)</option></select>
          </div>
          <div class="form-row">
            <label for="vis-group">Group by</label>
            <select id="vis-group"><option value="grade">Grade</option><option value="agency">Agency</option></select>
          </div>
          <div>
            <button id="gen-chart" class="btn">Generate chart</button>
          </div>
        </div>
        <div class="card">
          <strong>Chart</strong>
          <div id="chart-wrap" class="chart-area" aria-label="Chart of average pay"></div>
          <div id="chart-desc" class="muted small">You can save the chart as an image (right click → Save image).</div>
        </div>
      </div>
    </section>

    <section id="view-analysis" class="view" style="display:none" aria-hidden="true">
      <h2>Statistical analysis</h2>
      <div class="card">
        <div class="form-row">
          <label for="sim-pct">Raise simulator (%)</label>
          <input id="sim-pct" type="range" min="0" max="50" value="0" aria-valuemin="0" aria-valuemax="50" />
          <div class="muted small">Change: <span id="sim-value">0</span>%</div>
        </div>
        <div id="sim-result" class="muted small" style="margin-top:8px">Impact on budget: —</div>
        <div style="margin-top:12px"><button id="run-sim" class="btn">Run simulation</button></div>
      </div>
    </section>

    <section id="view-reports" class="view" style="display:none" aria-hidden="true">
      <h2>Report generation</h2>
      <div class="card">
        <div class="form-row">
          <label for="report-format">Format</label>
          <select id="report-format"><option value="csv">CSV</option><option value="pdf">Print / PDF</option></select>
        </div>
        <div style="margin-top:8px">
          <button id="generate-report" class="btn">Generate report</button>
        </div>
        <div id="report-preview" style="margin-top:12px"></div>
      </div>
    </section>

    <section id="view-admin" class="view" style="display:none" aria-hidden="true">
      <h2>Administration</h2>
      <div class="card">
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
          <button id="create-user" class="btn">Create account</button>
        </div>
        <div class="table-wrap">
          <table aria-label="User list">
            <thead><tr><th>Login</th><th>Role</th><th>Last login</th><th>Actions</th></tr></thead>
            <tbody id="admin-users"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="view-help" class="view" style="display:none" aria-hidden="true">
      <h2>Help &amp; documentation</h2>
      <div class="card">
        <h3>Required file format</h3>
        <p class="muted">CSV file containing at least columns: <code>name,agency,grade,salary,start_date</code>. Separator: <strong>;</strong> or <strong>,</strong></p>
      </div>
    </section>
  </main>
</div>

<div id="modal-root" aria-hidden="true"></div>
<div id="toast-root" aria-live="polite" style="position:fixed; right:18px; bottom:18px"></div>

<script>
/* Handle displaying current user and logging out */
const currentUser = localStorage.getItem('kallos_user');
document.getElementById('displayUsername').textContent = currentUser || 'Guest';

document.getElementById('logoutBtn').addEventListener('click', () => {
  const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
  localStorage.removeItem('kallos_user');
  // Pass current theme in URL so the login screen can restore it
  window.location.href = 'kallos-login.html?logout=true&theme=' + encodeURIComponent(currentTheme);
});

/* FULL APPLICATION LOGIC BELOW (IMPORT, CHARTS, ETC) */
const state = {
  view: 'dashboard',
  data: [], 
  users: [ {login:'admin', role:'Administrator', last:'2025-12-19'} ]
};

/* ======= UTILITIES ======= */
function $(sel,root=document) { return root.querySelector(sel) }
function $all(sel,root=document){ return Array.from(root.querySelectorAll(sel)) }
function setStatus(msg){ const s=$('#status'); s.textContent=msg; s.classList.remove('visually-hidden'); setTimeout(()=>s.classList.add('visually-hidden'),3000) }
function showToast(msg, opts={}) {
  const root = document.getElementById('toast-root');
  const el = document.createElement('div'); el.className='toast'; el.textContent=msg;
  root.appendChild(el);
  setTimeout(()=>el.remove(), 3500);
}
/* ======= THEME SWITCH - POPRAWIONA LOGIKA ======= */
const themeSelect = $('#theme-select');
// 1. Ustaw select na wartość z pamięci (żeby pokazywał dobrą opcję)
themeSelect.value = localStorage.getItem('kallos_theme') || 'light';

// 2. Przy zmianie - zapisz w pamięci
themeSelect.addEventListener('change', e=>{
  const newTheme = e.target.value;
  // Ustawiamy atrybut na <html> (documentElement), nie na body, to lepsza praktyka
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('kallos_theme', newTheme);
});

/* ======= NAVIGATION ======= */
$all('nav.sidebar button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    $all('nav.sidebar button').forEach(b=>b.removeAttribute('aria-current'));
    btn.setAttribute('aria-current','true');
    showView(btn.dataset.view);
  });
});
function showView(name){
  state.view=name;
  $all('main.content .view').forEach(v=>{
    if (v.id === 'view-' + name) { v.style.display='block'; v.setAttribute('aria-hidden','false') }
    else { v.style.display='none'; v.setAttribute('aria-hidden','true') }
  });
}

/* ======= QUICK IMPORT BUTTON (shortcut to view) ======= */
$('#quick-import').addEventListener('click', ()=>{
  document.querySelector('nav.sidebar button[data-view="import"]').click();
  $('#file-input').focus();
});

/* ======= IMPORT: handle file selection, preview, mapping ======= */
let lastHeaders = [];
$('#file-input').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if (!file) return;
  const text = await file.text();
  const sep = text.includes(';') ? ';' : ',';
  const lines = text.split(/\r?\n/).filter(Boolean);
  if (lines.length === 0) { alert('File is empty'); return; }
  lastHeaders = lines[0].split(sep).map(h=>h.trim());
  
  const mapArea = $('#map-area'); mapArea.style.display='block';
  const mapRows = $('#map-rows'); mapRows.innerHTML = '';
  const required = ['name','agency','grade','salary','start_date'];
  required.forEach(req=>{
    const row = document.createElement('div');
    row.className='form-row';
    row.innerHTML = `<label>${req} <span class="muted small">(wymagane)</span></label>
      <select data-target="${req}" aria-label="Mapuj ${req}">
        <option value="">-- wybierz kolumnę --</option>
        ${lastHeaders.map(h=>`<option value="${h}">${h}</option>`).join('')}
      </select>`;
    mapRows.appendChild(row);
  });

  const previewWrap = $('#preview-area'); previewWrap.style.display='block';
  const previewTable = document.createElement('table'); previewTable.style.width='100%';
  const th = document.createElement('thead'); th.innerHTML = '<tr>' + lastHeaders.map(h=>`<th>${h}</th>`).join('') + '</tr>';
  previewTable.appendChild(th);
  const tb = document.createElement('tbody');
  lines.slice(1,6).forEach(l=>{
    const cols = l.split(sep);
    tb.appendChild(document.createElement('tr')).innerHTML = cols.map(c=>`<td>${c}</td>`).join('');
  });
  previewWrap.querySelector('#preview-table-wrap').innerHTML=''; previewWrap.querySelector('#preview-table-wrap').appendChild(previewTable);
});

$('#start-import').addEventListener('click', ()=>{
  const selects = Array.from(document.querySelectorAll('#map-rows select'));
  const mapping = {};
  for (const sel of selects){
    if (!sel.value) {
      alert('Please map all required columns.');
      sel.focus();
      return;
    }
    mapping[sel.dataset.target]=sel.value;
  }
  const fileInput = $('#file-input');
  const file = fileInput.files[0];
  if (!file) { alert('No file selected'); return; }
  file.text().then(text=>{
    const sep = text.includes(';') ? ';' : ',';
    const lines = text.split(/\r?\n/).filter(Boolean);
    const headers = lines[0].split(sep).map(h=>h.trim());
    const rows = lines.slice(1).map(line => {
      const cols = line.split(sep);
      const obj = {};
      for (const key in mapping) {
        const colName = mapping[key];
        const idx = headers.indexOf(colName);
        obj[key] = idx>=0 ? (cols[idx]||'').trim() : '';
      }
      obj.salary = parseFloat( (obj.salary || '0').replace(/[^\d.,-]/g,'').replace(',','.') ) || 0;
      return obj;
    }).filter(r=>r.name && r.agency);
    
    state.data = state.data.concat(rows);
    updateKPI();
    populateFilters();
    renderTable();
    showToast('Import finished: ' + rows.length + ' records');
    $('#map-area').style.display='none';
    $('#preview-area').style.display='none';
    fileInput.value='';
    addLog(`Import: ${rows.length} records`);
  });
});

$('#cancel-import').addEventListener('click', ()=>{
  $('#map-area').style.display='none';
  $('#preview-area').style.display='none';
  $('#file-input').value='';
});

/* ======= TABLE RENDERING ======= */
function renderTable(){
  const tbody = $('#table-body'); tbody.innerHTML='';
  const q = $('#search-input').value.trim().toLowerCase();
  let visible = state.data;
  if (q) visible = visible.filter(r => (r.name||'').toLowerCase().includes(q) || (r.agency||'').toLowerCase().includes(q));
  visible.forEach((row,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input data-idx="${i}" class="row-check" type="checkbox" aria-label="Zaznacz rekord ${row.name}"></td>
      <td>${escapeHtml(row.name)}</td>
      <td>${escapeHtml(row.agency)}</td>
      <td>${escapeHtml(row.grade)}</td>
      <td>${row.salary.toLocaleString('pl-PL', {style:'currency', currency:'USD', maximumFractionDigits:0})}</td>
      <td>${escapeHtml(row.start_date)}</td>`;
    tbody.appendChild(tr);
  });
  $('#kpi-records').textContent = state.data.length;
  attachRowCheckboxes();
}
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

$('#search-input').addEventListener('input', ()=> renderTable());

$('#select-all').addEventListener('change', (e)=>{
  const checks = $all('.row-check');
  checks.forEach(c=>c.checked = e.target.checked);
  updateSelectedCount();
});
function attachRowCheckboxes(){
  $all('.row-check').forEach(cb=>{
    cb.addEventListener('change', updateSelectedCount);
  });
}
function updateSelectedCount(){
  const count = $all('.row-check').filter(c=>c.checked).length;
  $('#selected-count').textContent = count;
}

$('#export-csv').addEventListener('click', ()=>{
  if (state.data.length===0) { alert('No data to export'); return; }
  const csv = toCSV(state.data);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='kallos_export.csv'; a.click(); URL.revokeObjectURL(url);
  showToast('CSV export generated');
});

function toCSV(arr){
  if (!arr.length) return '';
  const cols = Object.keys(arr[0]);
  const rows = [cols.join(',')].concat(arr.map(r=>cols.map(c=>`"${String(r[c]||'').replace(/"/g,'""')}"`).join(',')));
  return rows.join('\n');
}

/* ======= CHART ======= */
function generateChart(groupBy='grade'){
  const groups = {};
  state.data.forEach(r=>{
    const key = r[groupBy] || '(brak)';
    if (!groups[key]) groups[key] = {sum:0,count:0};
    groups[key].sum += (r.salary||0); groups[key].count++;
  });
  const items = Object.entries(groups).map(([k,v])=>({k,avg: v.count ? v.sum/v.count : 0, count:v.count}))
    .sort((a,b)=>b.avg-a.avg);
  renderSVGChart('#mini-chart', items, {height:100, showLabels:false});
  renderSVGChart('#chart-wrap', items, {height:260, showLabels:true});
}

function renderSVGChart(selector, items, opts={height:200, showLabels:true}){
  const wrap = document.querySelector(selector);
  wrap.innerHTML='';
  if (!items.length) { wrap.innerHTML = '<div class="muted">Brak danych</div>'; return; }
  const max = Math.max(...items.map(i=>i.avg));
  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS,'svg');
  svg.setAttribute('width','100%'); svg.setAttribute('height', opts.height);
  const pad = 36;
  const width = wrap.clientWidth || 600;
  const barW = Math.max(20, Math.floor((width - pad*2)/items.length) - 8);
  items.forEach((it, idx)=>{
    const x = pad + idx*(barW+8);
    const h = max ? ( (it.avg / max) * (opts.height - 80) ) : 0;
    const y = opts.height - h - 30;
    const rect = document.createElementNS(svgNS,'rect');
    rect.setAttribute('x', x);
    rect.setAttribute('y', y);
    rect.setAttribute('width', barW);
    rect.setAttribute('height', h);
    rect.setAttribute('fill', 'url(#g'+idx+')'); 
    rect.setAttribute('fill', 'var(--primary)'); 
    rect.setAttribute('rx',4);
    rect.setAttribute('role','img');
    rect.setAttribute('aria-label', `${it.k}: average ${Math.round(it.avg)} USD, ${it.count} records`);
    svg.appendChild(rect);
    if (opts.showLabels){
      const text = document.createElementNS(svgNS,'text');
      text.setAttribute('x', x + barW/2);
      text.setAttribute('y', y - 6);
      text.setAttribute('text-anchor','middle');
      text.setAttribute('font-size','12');
      text.setAttribute('fill', 'var(--text)');
      text.textContent = Math.round(it.avg).toLocaleString('pl-PL') + ' USD';
      svg.appendChild(text);

      const lab = document.createElementNS(svgNS,'text');
      lab.setAttribute('x', x + barW/2);
      lab.setAttribute('y', opts.height - 10);
      lab.setAttribute('text-anchor','middle');
      lab.setAttribute('font-size','11');
      lab.setAttribute('fill','var(--muted)');
      lab.textContent = it.k;
      svg.appendChild(lab);
    }
  });
  wrap.appendChild(svg);
}

$('#gen-chart').addEventListener('click', ()=>{
  generateChart($('#vis-group').value);
});

/* ======= ANALYSIS ======= */
$('#sim-pct').addEventListener('input', (e)=> $('#sim-value').textContent = e.target.value);
$('#run-sim').addEventListener('click', ()=>{
  const pct = parseFloat($('#sim-pct').value) || 0;
  const base = state.data.reduce((s,r)=>s + (r.salary||0),0);
  const newTotal = base * (1 + pct/100);
  const diff = newTotal - base;
  $('#sim-result').textContent = `Current budget: ${Math.round(base).toLocaleString('pl-PL')} USD. After raise: ${Math.round(newTotal).toLocaleString('pl-PL')} USD. Change: ${Math.round(diff).toLocaleString('pl-PL')} USD.`;
  addLog(`Simulation: +${pct}% -> ${Math.round(diff)} USD`);
});

$('#generate-report').addEventListener('click', ()=>{
  const fmt = $('#report-format').value;
  if (fmt === 'csv'){
    const csv = toCSV(state.data);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'kallos_report.csv'; a.click();
    showToast('Raport CSV wygenerowany lokalnie');
  } else {
    const w = window.open('', '_blank');
    w.document.write('<pre>' + escapeHtml(JSON.stringify(state.data.slice(0,200), null, 2)) + '</pre>');
    w.document.close();
    w.print();
  }
});

/* ======= ADMIN ======= */
function renderAdminUsers(){
  const tbody = $('#admin-users'); tbody.innerHTML='';
  state.users.forEach((u,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.login}</td><td>${u.role}</td><td>${u.last}</td><td>
      <button data-idx="${i}" class="small btn-outline delete-user">Delete</button>
    </td>`;
    tbody.appendChild(tr);
  });
}

// Handle removing user from the list
document.getElementById('admin-users').addEventListener('click', (e)=>{
  const btn = e.target.closest('.delete-user');
  if (!btn) return;
  const idx = parseInt(btn.getAttribute('data-idx'), 10);
  if (Number.isNaN(idx) || idx < 0 || idx >= state.users.length) return;
  const user = state.users[idx];
  if (!confirm(`Are you sure you want to delete user "${user.login}"?`)) return;
  state.users.splice(idx, 1);
  renderAdminUsers();
  showToast(`Deleted user: ${user.login}`);
});
$('#create-user').addEventListener('click', ()=>{
  const login = prompt('Login for new account:','user1');
  if (!login) return;
  state.users.push({login, role:'User', last:'-'});
  renderAdminUsers();
  showToast('Created account: '+login);
});
renderAdminUsers();

/* ======= HELPERS ======= */
function updateKPI(){
  $('#kpi-records').textContent = state.data.length;
  const avg = state.data.length ? Math.round(state.data.reduce((s,r)=>s + (r.salary||0),0) / state.data.length) : '—';
  $('#kpi-avg').textContent = (avg === '—') ? '—' : avg.toLocaleString('pl-PL') + ' USD';
  $('#kpi-last').textContent = new Date().toLocaleString('pl-PL');
}
function populateFilters(){
  const agencies = Array.from(new Set(state.data.map(d=>d.agency).filter(Boolean))).sort();
  const sel = $('#filter-agency'); sel.innerHTML = '<option value="">Wszystkie</option>' + agencies.map(a=>`<option>${a}</option>`).join('');
  const years = Array.from(new Set(state.data.map(d=> (d.start_date||'').slice(0,4) ).filter(Boolean))).sort().reverse();
  $('#filter-year').innerHTML = '<option value="">Wszystkie</option>' + years.map(y=>`<option>${y}</option>`).join('');
}
function addLog(txt){
  const ul = $('#log-list');
  const li = document.createElement('li'); li.textContent = `[${new Date().toLocaleTimeString('pl-PL')}] ${txt}`;
  ul.insertBefore(li, ul.firstChild);
}

/* initial demo dataset */
(function seed(){
  const demo = [
    {name:'Anna Smith', agency:'Dept. of Health', grade:'G5', salary:6800, start_date:'2019-06-02'},
    {name:'John Miller', agency:'Dept. of Finance', grade:'G7', salary:9200, start_date:'2015-08-15'},
    {name:'Mary Johnson', agency:'Dept. of Health', grade:'G5', salary:7000, start_date:'2020-01-10'},
    {name:'Peter Green', agency:'Dept. of Education', grade:'G4', salary:5400, start_date:'2021-03-01'},
    {name:'Kate Brown', agency:'Dept. of Finance', grade:'G6', salary:8100, start_date:'2018-11-30'}
  ];
  state.data = state.data.concat(demo);
  updateKPI(); populateFilters(); renderTable(); generateChart('grade');
})();

window._Kallos = {state, generateChart, renderTable};
</script>
</body>
</html>